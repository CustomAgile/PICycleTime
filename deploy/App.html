<!DOCTYPE html>
<html>
<head>
    <title>PI Cycle Time Chart</title>
    <!--  (c) 2020 Custom Agile.  All Rights Reserved. -->
    <!--  Build Date: Mon Oct 05 2020 16:20:43 GMT-0400 (Eastern Daylight Time) -->
    <!--  Version: "1.1.0"-->
    <!--  Repository: "https:/github.com/CustomAgile/PICycleTime"-->
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.override(Rally.ui.inlinefilter.OperatorFieldComboBox,{_getAllowedQueryOperatorStore:function(){var e={fields:["name","displayName","OperatorName"],filters:[{property:"OperatorName",operator:"!=",value:"containsall"},{property:"OperatorName",operator:"!=",value:"containsany"},{property:"OperatorName",operator:"!=",value:"in"}],listeners:{load:function(e,t){_.each(t,function(t){var i=t.get("OperatorName");t.set("name",i),t.set("displayName",e.shouldReplaceOperatorName?i.replace("contains","="):i),t.commit(!1)},this),e.add(this.additionalOperators),e.commitChanges()},scope:this}};if(this.property){var t=this.model.getField(this.property),i=t.getAllowedQueryOperatorStore();i&&(e.autoLoad=!1,e.proxy=i.proxy.clone(),e.shouldReplaceOperatorName=t.isCollection())}return Ext.create("Ext.data.Store",e)}}),Ext.override(Rally.ui.inlinefilter.FilterFieldFactory,{_getBaseEditorConfig:function(e,t){if("CreatedBy"===e.name){return{xtype:"rallyusersearchcombobox",fieldLabel:e.displayName,allowNoEntry:!1,valueField:"_uuidRef",storeConfig:{models:[e.attributeDefinition.AllowedValueType._refObjectName],context:{workspace:t.getDataContext().workspace,project:null}}}}return this.callParent(arguments)}}),Ext.override(Rally.ui.inlinefilter.InlineFilterPanel,{_alignChevron:function(){this.chevron&&this.chevron.hide()},_createCloseButton:function(){}}),Ext.override(Ext.form.field.ComboBox,{select:function(e){e&&!e.get("ObjectID")&&"/allowedattributevalue/"===e.get("_uuidRef")||this.callParent(arguments)}}),Ext.override(Rally.ui.inlinefilter.QuickFilterPanel,{getFilters:function(){var e=[];return _.each(this.fields,function(t,i){if("ModelType"!==t.name&&!Ext.isEmpty(t.lastValue)&&!t.hasActiveError()){var s=t.lastValue,r=Rally.util.Ref.isRefUri(s),l=_.isNumber(Rally.util.Ref.getOidFromRef(s));if(r&&l&&"_ref"===t.valueField&&t.noEntryValue!==s){var o=t.getRecord();if(o){var n=o.get("_uuidRef");n&&(s=n)}}var a=_.isFunction(t.getFilter)?t.getFilter():Rally.data.wsapi.Filter.fromExtFilter({property:t.name,operator:t.operator,value:s});a&&"/allowedattributevalue/"!==a.value&&(t.allowNoEntry&&t.noEntryValue===s&&(a.value=null),Ext.apply(a,{name:t.name,rawValue:s,filterIndex:i+1}),e.push(a))}},this),e}}),Ext.override(Ext.form.field.Checkbox,{getState:function(){return{checked:this.getValue()}},applyState:function(e){"boolean"==typeof e.checked&&this.setValue(e.checked)}}),Ext.define("CustomAgile.multilevelfilter.ToggleButton",{extend:"Rally.ui.Button",alias:"widget.multifiltertogglebtn",stateful:!0,config:{iconCls:"icon-filter"},constructor:function(e){this.mergeConfig(e),this.callParent([this.config])},getState:function(){return{filtersHidden:this.filtersHidden}},setFiltersHidden:function(e){this.filtersHidden=e,this.saveState()}}),Ext.define("CustomAgile.ui.tutorial.MultiLevelFilterTutorial",{singleton:!0,welcomeHtml:"\n        <h3>This component enables filters to be applied to user stories and all levels within the portfolio item hierarchy, regardless of the artifact \n        type displayed in the app.</h3>\n\n        <h3><b>Note:</b> For grid apps that allow expanding individual rows to see child artifacts, these filters are only applied to the top-level artifact type. \n        Child artifacts will not be filtered.</h3>\n    ",defaultOffset:[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}],defaultChevronOffset:[{x:0,y:-14},{x:14,y:0},{x:0,y:14},{x:-8,y:0}],showWelcomeDialog:function(e){this.app=e,this.steps=this.getSteps(),this.app.showFiltersBtn&&this.app.showFiltersBtn.filtersHidden&&this.app._toggleFilters(this.app.showFiltersBtn);let t=Rally.getApp().getHeight()-25;this.welcomeDialog=Ext.create("Rally.ui.dialog.Dialog",{autoShow:!0,layout:"fit",componentCls:"rly-popover dark-container",width:500,height:t<300?t:300,closable:!0,autoDestroy:!0,buttonAlign:"center",autoScroll:!0,title:"Using the Multi-Level Filter",items:{xtype:"component",html:this.welcomeHtml,padding:10,style:"font-size:12px;"},buttons:[{xtype:"rallybutton",text:"Close",cls:"secondary rly-small",listeners:{click:()=>{this.welcomeDialog.close()},scope:this}},{xtype:"rallybutton",text:"Next",cls:"primary rly-small",listeners:{click:function(){this.showNextStep(0),this.welcomeDialog.close()},scope:this}}]})},showNextStep:function(e){if(this.popover&&Ext.destroy(this.popover),e>=this.steps.length)return;if(-1===e)return void this.showWelcomeDialog(this.app);let t=this.steps[e];t.handler&&t.handler();let i=[{xtype:"rallybutton",text:"Close",cls:"secondary rly-small",listeners:{click:()=>{this.popover.close()},scope:this}}];i.push({xtype:"rallybutton",text:"Previous",cls:"primary rly-small",listeners:{click:function(){this.showNextStep(e-1)},scope:this}}),e<this.steps.length-1&&i.push({xtype:"rallybutton",text:"Next",cls:"primary rly-small",listeners:{click:function(){this.showNextStep(e+1)},scope:this}});let s=Rally.getApp().getHeight()-25;this.popover=Ext.create("Rally.ui.popover.Popover",{target:Rally.getApp().down(t.target).getEl(),placement:t.placement||["bottom","left","top","right"],chevronOffset:t.chevronOffset||this.defaultChevronOffset,offsetFromTarget:t.offset||this.defaultOffset,overflowY:"auto",maxWidth:550,maxHeight:s<700?s:700,toFront:Ext.emptyFn,buttonAlign:"center",title:t.title,listeners:{destroy:function(){this.popover=null},scope:this},html:`<div class="tutorial-popover-body">${t.html}</div>`,buttons:i})},getSteps:function(){let e=[];if(this.app.publisher&&e.push({target:"#pubSubIndicatorArea",placement:"right",title:"Broadcaster Indicator",offset:[{x:0,y:0},{x:0,y:0},{x:14,y:0},{x:0,y:0}],chevronOffset:[{x:0,y:-14},{x:14,y:-40},{x:0,y:14},{x:-8,y:0}],html:'\n           <p><span class="icon-bullhorn icon-large"></span> This bullhorn icon indicates that the app is broadcasting the selected filters to any apps on the page\n         that are listening for filter changes.</p>\n            '}),this.app._showAncestorFilter()&&e.push({target:"#ancestorFilterArea",placement:"bottom",title:"Ancestor Filter",html:"\n         <p>The ancestor filter allows you to filter the data to show only artifacts that are descendants of the selected artifact. \n         Use the PI Type dropdown to choose which type of Portfolio Item you want the ancestor artifact to be.</p> \n            "}),this.app._showIgnoreProjectScopeControl()){let t;t=this.app.tabPanel?this.app.tabPanel.down("#ignoreScopeControl"):this.app.renderArea.down("#ignoreScopeControl"),this.app.tabPanel.setActiveTab(0);let i=t?0:-100;e.push({target:"#ignoreScopeControl",placement:"bottom",title:"Projects Tab (Scope Control)",offset:[{x:0,y:0},{x:0,y:0},{x:0,y:15},{x:0,y:0}],chevronOffset:[{x:0,y:-14},{x:14,y:0},{x:i,y:14},{x:-8,y:0}],html:'\n           <p>This dropdown controls whether the filters and resulting data will be scoped to the current project (Obeying the user\'s \n        Project Scope Down and Project Scope Up settings), scoped across all projects within the workspace or scoped across specific projects selected by the user.</p>\n        <p>To select specific projects, select the "Specific Project(s)" value in the drop down and then select the projects in the Project Picker. \n        Also, you can check the "Show work from Child Projects" to include all the children of selected projects. At last click the Apply button to apply your selection(s).</p>\n        <p>Depending upon the app and the filters, scoping across all projects may result in performance issues or timeout errors from the server. To ensure \n        timely performance, use filters that will return a manageable number of results.</p>\n            '})}let t=this.app._showAncestorFilter()||this.app._showIgnoreProjectScopeControl()?0:-225;return e.push({target:"multifiltertogglebtn",placement:"bottom",title:"Hide/Clear/Apply Filter Buttons",offset:[{x:0,y:0},{x:0,y:0},{x:0,y:14},{x:0,y:0}],chevronOffset:[{x:0,y:-14},{x:14,y:0},{x:t,y:14},{x:-8,y:0}],html:'\n           <ul class="filter-help-list">\n        <li><b>Show/Hide Filters: </b>Used to toggle the visibility of the filter controls. Use this to hide the filters if they\'re \n        not needed or more space is needed within the app</li>\n        \n        <li><b>Clear Filters: </b>Once at least 1 filter is applied, this button will appear. This button will clear all of the quick filters and advanced filters across all artifact types. \n        Upon clearing the filters, the app will refresh its data.</li>\n        \n        <li><b>Apply Filters: </b>If present, this button becomes active after a single change is made to one of the filters. This button \n        allows the user to make multiple changes without the app refreshing after each change. Once the user has modified all of \n        the necessary filters, clicking this button will apply it to the app and refresh the data. If this button is not present, \n        the app will refresh after each change made to the filters.</li>\n        </ul>\n            '},{target:"#multiLevelFilterTabPanel tabbar",placement:"bottom",title:"Artifact Type Tabs",offset:[{x:0,y:0},{x:0,y:0},{x:0,y:14},{x:0,y:0}],chevronOffset:[{x:0,y:-14},{x:14,y:0},{x:-25,y:14},{x:-8,y:0}],html:"\n           <p>Each tab contains a unique filter that will apply filters at the level of the specified artifact type. \n        If the tab title ends with a number in parenthesis, this indicates the current number of filters applied at that level.</p>\n            "},{target:"#"+this.app.btnRenderAreaId,placement:"bottom",title:"Errors",chevronOffset:[{x:0,y:-14},{x:14,y:0},{x:0,y:28},{x:-8,y:0}],html:"\n            <h4><i>One of the filters is trying to return too many records and would result in timeouts...</i></h4>\n        <ul>\n        <li>Often times, when using filters on artifact types above or below the artifact type displayed within the app, it's necessary \n        to first fetch those artifacts at that level in order to properly apply the filters. If the number of artifacts fitting those \n        filters is too large, it's too slow or impossible to retrieve all of them in order to then use them as filters afterwards.\n        <br><br>\n        <b>Example: </b>\n        Using a grid to display Features across all projects. We only want to see Features that have User Stories that are blocked. \n        Since there's no way to directly search for Features containing blocked stories, we must first find all blocked stories so we can \n        build a list of Features that are tied to those stories. And since we're scoping across all projects, we must query for all blocked \n        stories across the workspace. The results would be over ten thousand records, which would take very long to load, or would fail \n        to load due to timeout errors. This is an example of when we would see this error. Using more specific filters, or scoping to a specific \n        project hierarchy would solve this issue.\n        </li>\n        </ul>\n            "}),e}}),Ext.define("Utils.AncestorPiAppFilter",{alias:"plugin.UtilsAncestorPiAppFilter",version:"1.4.0",mixins:["Ext.AbstractPlugin","Rally.Messageable"],extend:"Ext.Component",statics:{RENDER_AREA_ID:"utils-ancestor-pi-app-filter",PANEL_RENDER_AREA_ID:"multi-level-pi-app-filter-panel"},config:{renderAreaId:"utils-ancestor-pi-app-filter",btnRenderAreaId:"utils-ancestor-pi-app-filter",panelRenderAreaId:"multi-level-pi-app-filter-panel",displayMultiLevelFilter:!1,projectScope:"user",publisher:!1,allowNoEntry:!0,settingsConfig:{},defaultFetch:!0,whiteListFields:["Tags","Milestones","c_EAEpic","c_EnterpriseApprovalEA","DisplayColor"],overrideGlobalWhitelist:!1,blackListFields:[],filterChildren:!1,ancestorLabel:"With ancestor",ancestorLabelWidth:110,ownerLabel:"and owned by",ownerOnlyLabel:"Owned by",ownerLabelWidth:110,labelStyle:"font-size: medium",singleRowMinWidth:840,defaultFilterFields:[],filtersHidden:!1,advancedFilterCollapsed:!1,visibleTab:void 0,disableGlobalScope:!1},filterControls:[],portfolioItemTypes:[],readyDeferred:null,piTypesDeferred:null,isSubscriber:!1,changeSubscribers:[],publishedValue:{},defaultTab:0,constructor:function(){this.callParent(arguments),this._setupPubSub(),Ext.tip.QuickTipManager.init()},initComponent:function(){this.callParent(arguments),this.addEvents("ready","select","change")},init:function(e){this.cmp=e,this.cmp.on("resize",this._onCmpResize,this),this.renderArea=this.cmp.down("#"+this.renderAreaId),this.btnRenderArea=this.cmp.down("#"+this.btnRenderAreaId),this.panelRenderArea=this.cmp.down("#"+this.panelRenderAreaId),this.projectScope=this.projectScope&&this.projectScope.toLowerCase()||"",(!this.projectScope||"user"!==this.projectScope&&"current"!==this.projectScope&&"workspace"!==this.projectScope)&&(this.projectScope="user");var t=this.cmp.getSettingsFields;this.cmp.getSettingsFields=function(){return this._getSettingsFields(t.apply(e,arguments))}.bind(this);var i=this.cmp.defaultSettings;i["Utils.AncestorPiAppFilter.enableAncestorPiFilter2"]=!1,i["Utils.AncestorPiAppFilter.projectScope"]=this.projectScope,i["Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter"]=this.displayMultiLevelFilter,i["Utils.MultiLevelPiAppFilter.projectScope.dropdownCurrent"]="true",i["Utils.MultiLevelPiAppFilter.projectScope.dropdownAny"]="true",i["Utils.MultiLevelPiAppFilter.projectScope.dropdownSpecific"]="true",this.cmp.setDefaultSettings(i),this.projectsChanged=!0,this._getGlobalWhitelist().then({scope:this,success:function(e){this.whiteListFields=e,this._getTypeDefinitions().then({scope:this,success:function(){Promise.all([this._addAncestorControls(),this._addFilters()]).then(function(){setTimeout(function(){this._setReady()}.bind(this),500)}.bind(this),function(e){this._showError(e,"Failed while adding ancestor and multilevel filters"),this._setReady()}.bind(this))},failure:function(){this._showError("Failed to fetch portfolio item types for multi-level filter")}})}})},_getGlobalWhitelist:function(){let e=Ext.create("Deft.Deferred"),t="multi-level-filter-whitelist-fields-preference-"+this.cmp.getContext().getWorkspaceRef();return this.overrideGlobalWhitelist?(e.resolve(this.whiteListFields),e.promise):(Rally.data.PreferenceManager.load({filterByName:t,scope:this,success:function(i){if(i&&i.hasOwnProperty(t))try{let s=i[t].split(",");s&&s.length?e.resolve(s):e.resolve(this.whiteListFields)}catch(t){e.resolve(this.whiteListFields)}else e.resolve(this.whiteListFields)}}),e.promise)},_getTypeDefinitions:function(){let e=Ext.create("Deft.Deferred");return Rally.data.util.PortfolioItemHelper.getPortfolioItemTypes().then({scope:this,success:function(t){this.portfolioItemTypes=t,Ext.create("Rally.data.wsapi.Store",{model:Ext.identityFn("TypeDefinition"),fetch:["Name","Ordinal","TypePath"],requester:this,filters:[{property:"Name",value:"Hierarchical Requirement"}]}).load({scope:this,callback:function(t,i,s){s&&t&&t.length?(this.storyType=t[0],this.allTypes=[this.storyType].concat(this.portfolioItemTypes),Ext.create("Rally.data.wsapi.Store",{model:Ext.identityFn("TypeDefinition"),fetch:["Name","Ordinal","TypePath"],requester:this,filters:[{property:"Name",value:"Defect"}]}).load({scope:this,callback:function(t,i,s){s&&t&&t.length?(this.defectType=t[0],this.allTypes=[this.defectType].concat(this.allTypes),e.resolve()):e.reject()}})):e.reject()}})},failure:function(){e.reject()}}),e.promise},notifySubscribers:async function(e){var t=this._getValue();t.changeType=e,this.projectsChanged&&(Rally.getApp().setLoading("Loading Projects...."),await this.loadProjects(),Rally.getApp().setLoading(!1)),t.projects=this.projects,_.each(this.changeSubscribers,function(e){this.publish(e,t)},this)},getAncestorFilterForType:function(e){var t,i=e.toLowerCase(),s=this._getValue();if(s.piTypePath){var r=s.piTypePath,l=s.isPiSelected,o=s.pi,n=this._getAncestorTypeArray(i,r);if(l&&null!==o&&null!==n){var a=this._getPropertyPrefix(i,n);a&&(t=new Rally.data.wsapi.Filter({property:a,value:o}))}else null!==o&&(t=new Rally.data.wsapi.Filter({property:"ObjectID",value:0}))}return t},getAllFiltersForType:async function(e,t){let i=this.getAncestorFilterForType(e),s=i?[i]:[],r=await this.getMultiLevelFiltersForType(e,t);return s=s.concat(r),this.projectsChanged?await this.loadProjects():this._isSubscriber()&&this.publishedValue.projects&&(this.projects=this.publishedValue.projects),this.projects&&this.projects.length>0&&s.push(new Rally.data.wsapi.Filter({property:"Project",operator:"in",value:_.map(this.projects,function(e){return e.get("_ref")})})),s},getMultiLevelFiltersForType:async function(e,t){let i=[],s=e.toLowerCase(),r=this.getMultiLevelFilters();if(!r||!Object.keys(r).length)return i;let l=this._getAllTypePaths();for(let e=_.findIndex(l,function(e){return e.toLowerCase()===s});e<l.length;e++){let t=l[e],o=r[t];if(o&&o.length)if(s===t.toLowerCase())i=i.concat(this._getWsapiFilter(s));else{let e=await this._getParentFilters(s,t,o);i=i.concat(e)}}if(t&&(Ext.String.startsWith(e.toLowerCase(),"portfolioitem")||Ext.String.startsWith(e.toLowerCase(),"hierarchicalrequirement"))){let t=this._getChildFiltersForType(e);t&&(i=i.concat(t))}return i},getFiltersOfSingleType:async function(e){return this._getWsapiFilter(e)},getMultiLevelFilters:function(){if(this._isSubscriber())return this.publishedValue.filters||{};var e={};return this.filterControls&&_.each(this.filterControls,function(t){let i=t.inlineFilterButton.modelNames||"unknown";e[i]=t.inlineFilterButton.getFilters()}),e},getMultiLevelWsapiFilters:function(){if(this._isSubscriber())return this.publishedValue.wsapiFilters||{};var e={};return this.filterControls&&_.each(this.filterControls,function(t){let i=t.inlineFilterButton.modelNames||"unknown";e[i]=t.inlineFilterButton.getWsapiFilter()}),e},_getChildFiltersForType:function(e){let t=this._getAllTypePaths(),i="",s=[];for(let r=_.findIndex(t,function(t){return t.toLowerCase()===e.toLowerCase()})-1;r>=0;r--){let e=t[r];i=i+(i.length?".":"")+("hierarchicalrequirement"===e.toLowerCase()?"UserStories":"defect"===e.toLowerCase()?"Defects":"Children"),s=s.concat(this._getWsapiFilter(e,i))}return s},_getParentFilters:async function(e,t,i){let s=this._getAncestorTypeArray(e,t);if(null!==s){let r=this._getPropertyPrefix(e,s);if(r){let e=this._hasCustomFilters(i),s=[new Rally.data.wsapi.Filter({property:r+".ObjectID",operator:"=",value:0})];if(!e||!this.getIgnoreProjectScope())return this._getWsapiFilter(t,r);{let e=[];try{let i=this._getWsapiFilter(t);return(e=await new Promise(function(e,s){this._getFilteredRecords(i,t,e,s)}.bind(this)).catch(e=>(this._showError(e,"Failed while loading filters for parent artifacts"),[])))&&e.length?[new Rally.data.wsapi.Filter({property:r+".ObjectID",operator:"in",value:_.map(e,function(e){return e.get("ObjectID")})})]:s}catch(e){return this._showError(e,"Failed while loading filters for parent artifacts"),s}}}}return[]},_getWsapiFilter:function(e,t){let i;if(this._isSubscriber()){if(this.publishedValue.wsapiFilters)for(let t in this.publishedValue.wsapiFilters)if(t.toLowerCase()===e.toLowerCase()){(i=this.publishedValue.wsapiFilters[t])&&(i=i.clone());break}}else this.filterControls&&_.each(this.filterControls,function(t){(t.inlineFilterButton.modelNames||"unknown").toLowerCase()===e.toLowerCase()&&(i=t.inlineFilterButton.getWsapiFilter())&&(i=i.clone())});return i&&(this._updateColorAndCustomFilters(i),t&&this._updateWsapiFilterWithPrefix(i,t)),i?[i]:[]},_updateColorAndCustomFilters:function(e){e&&(e.property&&"object"==typeof e.property&&this._updateColorAndCustomFilters(e.property),"object"==typeof e.value?this._updateColorAndCustomFilters(e.value):("string"==typeof e.value&&/^#[0-9a-f]{3,6}$/i.test(e.value)&&(e.value=e.value.toLowerCase()),"HasDefects"!==e.property&&"HasStories"!==e.property||(e.property="HasDefects"===e.property?"Defects.ObjectID":"UserStories.ObjectID",e.operator=("="===e.operator||"in"===e.operator)&&e.value||"!="===e.operator&&!e.value?"!=":"=",e.value=null)))},_updateWsapiFilterWithPrefix:function(e,t){e&&(e.property&&("string"==typeof e.property?(e.config&&e.property===e.config.property&&(e.config.property=`${t}.${e.property}`),e.initialConfig&&e.property===e.initialConfig.property&&(e.initialConfig.property=`${t}.${e.property}`),e.property=`${t}.${e.property}`):this._updateWsapiFilterWithPrefix(e.property,t)),"object"==typeof e.value&&this._updateWsapiFilterWithPrefix(e.value,t))},_hasCustomFilters:function(e){for(let t of e)if(-1!==t.property.indexOf("c_")&&"string"==typeof t.value)return!0;return!1},_convertReleaseFilters:async function(e){if(this.getIgnoreProjectScope())for(let t=0;t<e.length;t++)if("Release"===e[t].property){let i=await this._getRelease(e[t].value);i&&(e[t]=new Rally.data.wsapi.Filter({property:"Release.Name",value:i.Name}))}},_getRelease:async function(e){let t=Ext.create("Deft.Deferred");return Ext.Ajax.request({url:Ext.String.format("/slm/webservice/v2.0{0}?fetch=Name",e),success(e){if(e&&e.responseText){let i=Ext.JSON.decode(e.responseText);i&&i.Release?t.resolve(i.Release):t.resolve(null)}else t.resolve(null)}}),t.promise},getSelectedPiRecord:function(){return this._isSubscriber()?this.publishedValue.piRecord:this.piSelector&&this.piSelector.getRecord()},getIgnoreProjectScope:function(){return this._ignoreProjectScope()},getCurrentView:function(){let e=this._getValue(),t={...this.cmp.defaultSettings,...this.cmp.getSettings()},i={};for(let e of Object.keys(t))(e.indexOf("AncestorPiAppFilter")>-1||e.indexOf("MultiLevelPiAppFilter")>-1)&&(i[e]=t[e]);return e.settings=i,"user"===i["Utils.AncestorPiAppFilter.projectScope"]&&"specific"===e.scope?(e.projects=this.projectPicker.getProjectRefs(),e.searchChildProjects=this.projectPicker.includeChildProjects()):e.projects=[],delete e.piRecord,delete e.wsapiFilters,e},setCurrentView:async function(e){e.settings&&(this._checkViewSettings(e),this.cmp.updateSettingsValues(e.settings)),this.ready=!1,this.projectsChanged=!0,this.projects=[],await this.setMultiLevelFilterStates(e.filterStates),this.projectPicker&&(e.projects&&e.projects.length?await this.projectPicker.setValueFromPrjRef(e.projects,e.searchChildProjects||!1):this.projectPicker.reset()),e.piTypePath&&this._setPiSelector(e.piTypePath,e.pi);let t=this.cmp.down("#ignoreScopeControl");t&&(e.scope?(t.setValue(e.scope),"specific"===e.scope?this.hideShowProjectPicker("show"):this.hideShowProjectPicker("hide")):(t.setValue(e.ignoreProjectScope),this.hideShowProjectPicker("hide")),this.projectPicker&&this.projectPicker.down("#applyProjectsBtn").hide())},_setScopeControlToSpecific:function(){let e=this.cmp.down("#ignoreScopeControl");e&&(e.setValue("specific"),this.hideShowProjectPicker("show")),this.projectPicker&&this.projectPicker.down("#applyProjectsBtn").hide()},_checkViewSettings:function(e){let t=e.settings["Utils.AncestorPiAppFilter.projectScope"],i=e.settings["Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter"];i="boolean"==typeof i?i:"true"===i;let s={...this.cmp.defaultSettings,...this.cmp.getSettings()},r=s["Utils.AncestorPiAppFilter.projectScope"],l=s["Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter"];if(l="boolean"==typeof l?l:"true"===l,t!==r&&i&&l){let e=`<p> Unable to set saved view project scoping. App is currently set to scope to "\n                        ${"current"===r?"Users current project(s)":"workspace"===r?"All projects in workspace":"User selectable via projects tab"}" where as it should be set to "${"current"===t?"Users current project(s)":"workspace"===t?"All projects in workspace":"User selectable via projects tab"}" </p>`;this.Dialog=Ext.create("Rally.ui.dialog.Dialog",{autoShow:!0,layout:"fit",componentCls:"rly-popover dark-container",width:400,height:200,closable:!0,autoDestroy:!0,buttonAlign:"center",autoScroll:!0,title:"Warning",items:{xtype:"component",html:e,padding:10,style:"font-size:12px;"},buttons:[{xtype:"rallybutton",text:"Close",cls:"secondary rly-small",listeners:{click:()=>{this.Dialog.close()},scope:this}}]})}},getMultiLevelFilterStates:function(){if(this._isSubscriber())return this.publishedValue.filterStates||{};var e={};return this.filterControls&&_.each(this.filterControls,function(t){let i=t.inlineFilterButton.modelNames||"unknown";e[i]=t.inlineFilterButton.getState()}),e},getModels:function(){return this.models},getPortfolioItemTypes:function(){return this.portfolioItemTypes},getLowestPortfolioItemType:function(){return this.portfolioItemTypes[0]},setMultiLevelFilterStates:async function(e){if(this._isSubscriber())this.ready=!0;else if(e){this.suspendEvents(!1),this._clearAllFilters(!0),this.tabPanel&&this.tabPanel.removeAll();try{for(let t=0;t<this.filterControls.length;t++){let i=this.filterControls[t].inlineFilterButton,s=i.modelNames||"unknown";i.applyState(e[s]||{})}}catch(e){this._showError(e)}await this.addProjectPicker(),setTimeout(function(){this.ready=!0,this.resumeEvents(),this.tabPanel&&this.tabPanel.setActiveTab(this.defaultTab),this._onChange()}.bind(this),1500)}else this.ready=!0,this._clearAllFilters(!1)},mergeLegacyFilter:function(e,t,i,s){if(!this._isSubscriber()&&e&&t&&i){for(let s in e)if(e.hasOwnProperty(s)&&s===i)try{let i=e[s];if(t.matchType&&(i.matchType=t.matchType),"string"==typeof t.condition&&(i.condition=t.condition),t.quickFilters){if(t.quickFilterFields&&!t.quickFilterFields.length)for(let e of t.quickFilters)t.quickFilterFields.push(e.name);i.quickFilters=_.merge(i.quickFilters,t.quickFilters)}t.advancedFilters&&(i.advancedFilters=_.merge(i.advancedFilters,t.advancedFilters)),t.quickFilterFields&&(i.quickFilterFields=_.merge(i.quickFilterFields,t.quickFilterFields))}catch(e){console.error("Failed to merge legacy filter into multi-level filter")}s&&this.setMultiLevelFilterStates(e)}},_getFilteredRecords:async function(e,t,i,s){let r=Rally.getApp().getContext().getDataContext();this.getIgnoreProjectScope()&&(r.project=null);let l=this.getAncestorFilterForType(t);l&&l.value&&e.push(l);let o=["ObjectID"];"HierarchicalRequirement"===t?o.push("Feature"):o.push("Parent");let n=await this._getTotalResultCount(r,e,t);if(-1===n)s("Multi-level filter failed while filtering out items above or below selected portfolio item type.");else if(0===n)i([]);else if(n>6e3)s("One of the filters is trying to return too many records and would result in long load times or timeouts, try using more specific filters to reduce the total result-set.");else{Ext.create("Rally.data.wsapi.Store",{autoLoad:!1,context:r,filters:e,model:t,fetch:o,limit:1/0,enablePostGet:!0}).load().then({scope:this,success:function(e){i(e)},failure:function(){s("Multi-level filter failed while filtering out items above or below selected portfolio item type. Result set was probably too large.")}})}},_getTotalResultCount:function(e,t,i){let s=Ext.create("Deft.Deferred"),r=Ext.create("Rally.data.wsapi.Store",{autoLoad:!1,context:e,filters:t,model:i,fetch:["_ref"],limit:1,enablePostGet:!0});return r.load().then({scope:this,success:function(){s.resolve(r.totalCount)},failure:function(){s.resolve(-1)}}),s.promise},_setupPubSub:function(){this.publisher?(this.subscribe(this,"registerChangeSubscriber",async function(e){_.contains(this.changeSubscribers,e)||this.changeSubscribers.push(e);let t={};this.ready&&(t=this._getValue(),this.projectsChanged&&await this.loadProjects(),t.projects=this.projects),this.publish(e,t)},this),this.publish("reRegisterChangeSubscriber")):(this.subscriberEventName=Rally.getApp().getAppId()+this.$className,this.subscribe(this,this.subscriberEventName,function(e){this.isSubscriber||(this.isSubscriber=!0,this._hideControlCmp()),e.ready&&(this.intervalTimer&&(clearInterval(this.intervalTimer),delete this.intervalTimer),this.publishedValue=e,"ancestor"!==e.changeType&&e.changeType?"cancelFilters"===e.changeType?this._onCancel():this._onChange():this._onSelect())},this),this.publish("registerChangeSubscriber",this.subscriberEventName),this.registerAttempts=0,this.intervalTimer=setInterval(()=>{this.registerAttempts++,this.registerAttempts>=15?(clearInterval(this.intervalTimer),delete this.intervalTimer,delete this.registerAttempts):this.publish("registerChangeSubscriber",this.subscriberEventName)},800),this.subscribe(this,"reRegisterChangeSubscriber",function(){this.publish("registerChangeSubscriber",this.subscriberEventName)},this))},_getValue:function(){var e={};if(this._isSubscriber())e=this.publishedValue||{};else if(this.cmp&&this.ready){if(this.piTypeSelector){var t=this.piTypeSelector.getRecord();if(t&&this.piSelector){var i=t.get("TypePath"),s=this.piSelector.getRecord(),r=this.piSelector.getValue();_.merge(e,{piTypePath:i,isPiSelected:!!r,pi:r,piRecord:s})}}e.ignoreProjectScope=this._ignoreProjectScope(),e.filters=this.getMultiLevelFilters(),e.filterStates=this.getMultiLevelFilterStates(),e.wsapiFilters=this.getMultiLevelWsapiFilters(),e.scope=this.getProjectScope(),e.ready=this.ready}return e},_setReady:function(){if(this.cmp.on("beforehide",()=>{this.filterHelpBtn&&this.filterHelpBtn.hide()}),this.cmp.on("beforeshow",()=>{this.filterHelpBtn&&this.filterHelpBtn.show()}),!this._showMultiLevelFilter()&&this.filterHelpBtn&&this.filterHelpBtn.hide(),this._isSubscriber()){if(this.tabPanel&&this.tabPanel.hide(),this.showFiltersBtn&&this.showFiltersBtn.hide(),this.filterHelpBtn&&this.filterHelpBtn.hide(),!this.publishedValue.filters)return void setTimeout(function(){this.ready=!0,this.fireEvent("ready",this)}.bind(this),3e3)}else this._updateReleaseValues();this.ready=!0,this.fireEvent("ready",this)},_onSelect:function(){this.ready&&this.fireEvent("select",this)},_onCancel:function(){this.ready&&this.fireEvent("cancel",this.getMultiLevelFilters())},_onChange:function(){this.ready&&this.fireEvent("change",this.getMultiLevelFilters())},hideHelpButton:function(){this.filterHelpBtn&&this.filterHelpBtn.hide()},showHelpButton:function(){this.filterHelpBtn&&this.filterHelpBtn.show()},_getSettingsFields:function(e){var t=Rally.getApp().getSettings();t.hasOwnProperty("Utils.AncestorPiAppFilter.projectScope")||(t["Utils.AncestorPiAppFilter.projectScope"]=this.projectScope),t.hasOwnProperty("Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter")||(t["Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter"]=this.displayMultiLevelFilter);let i=t["Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter"],s=t["Utils.AncestorPiAppFilter.projectScope"];var r=[{xtype:"rallycheckboxfield",id:"Utils.AncestorPiAppFilter.enableAncestorPiFilter2",name:"Utils.AncestorPiAppFilter.enableAncestorPiFilter2",fieldLabel:"Filter artifacts by ancestor portfolio item"},{xtype:"rallyportfolioitemtypecombobox",id:"Utils.AncestorPiAppFilter.defaultPiType",name:"Utils.AncestorPiAppFilter.defaultPiType",fieldLabel:"Default Portfolio Item type",valueField:"TypePath",allowNoEntry:!1,defaultSelectionPosition:"last",plugins:[]},{xtype:"rallycheckboxfield",id:"Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter",name:"Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter",fieldLabel:"Enable multi-level portfolio item filter",value:i,listeners:{scope:this,change:function(e,t){i=!!t,e.fireEvent("updateRadio",t)}},bubbleEvents:["updateRadio"]},{xtype:"radiogroup",itemId:"radioButtons",fieldLabel:"Show artifacts from",columns:1,vertical:!0,allowBlank:!1,name:"Utils.AncestorPiAppFilter.projectScope",items:[{boxLabel:"User's current project(s).",name:"Utils.AncestorPiAppFilter.projectScope",inputValue:"current",checked:"current"===s||this.disableGlobalScope},{boxLabel:"All projects in workspace.",name:"Utils.AncestorPiAppFilter.projectScope",inputValue:"workspace",checked:"workspace"===s&&!this.disableGlobalScope,disabled:this.disableGlobalScope},{boxLabel:!0===i||"true"===i?"User selectable via projects tab.":"User selectable (either current project(s) or all projects in workspace).",name:"Utils.AncestorPiAppFilter.projectScope",itemId:"userRadio",inputValue:"user",checked:"user"===s&&!this.disableGlobalScope,disabled:this.disableGlobalScope}],listeners:{scope:this,change:function(e,t){e.fireEvent("checkBoxDisplay",t)}},handlesEvents:{updateRadio:function(e){this.down("#userRadio").setBoxLabel(!0===i||"true"===i?"User selectable via projects tab.":"User selectable (either current project(s) or all projects in workspace)."),this.fireEvent("checkBoxDisplay1",!!this.down("#userRadio").value&&this.down("#userRadio").inputValue,e)}},bubbleEvents:["checkBoxDisplay","checkBoxDisplay1"]},{xtype:"rallycheckboxfield",id:"Utils.MultiLevelPiAppFilter.projectScope.dropdownCurrent",name:"Utils.MultiLevelPiAppFilter.projectScope.dropdownCurrent",fieldLabel:"Current Project",value:t["Utils.MultiLevelPiAppFilter.projectScope.dropdownCurrent"],hidden:!("user"===s&&(!0===i||"true"===i)&&!this.disableGlobalScope),style:{marginLeft:"5%"},handlesEvents:{checkBoxDisplay:function(e){"user"===e["Utils.AncestorPiAppFilter.projectScope"]&&!0==(!0===i||"true"===i)?this.show():this.hide()},checkBoxDisplay1:function(e,t){!0===t&&"user"===e?this.show():this.hide()}}},{xtype:"rallycheckboxfield",id:"Utils.MultiLevelPiAppFilter.projectScope.dropdownAny",name:"Utils.MultiLevelPiAppFilter.projectScope.dropdownAny",fieldLabel:"Any Project",value:t["Utils.MultiLevelPiAppFilter.projectScope.dropdownAny"],hidden:!("user"===s&&(!0===i||"true"===i)&&!this.disableGlobalScope),style:{marginLeft:"5%"},handlesEvents:{checkBoxDisplay:function(e){"user"!==e["Utils.AncestorPiAppFilter.projectScope"]||!0!==i&&"true"!==i?this.hide():this.show()},checkBoxDisplay1:function(e,t){!0===t&&"user"===e?this.show():this.hide()}}},{xtype:"rallycheckboxfield",id:"Utils.MultiLevelPiAppFilter.projectScope.dropdownSpecific",name:"Utils.MultiLevelPiAppFilter.projectScope.dropdownSpecific",fieldLabel:"User Specific",value:t["Utils.MultiLevelPiAppFilter.projectScope.dropdownSpecific"],hidden:!("user"===s&&(!0===i||"true"===i)&&!this.disableGlobalScope),style:{marginLeft:"5%",marginBottom:"5px"},handlesEvents:{checkBoxDisplay:function(e){"user"!==e["Utils.AncestorPiAppFilter.projectScope"]||!0!==i&&"true"!==i?this.hide():this.show()},checkBoxDisplay1:function(e,t){!0===t&&"user"===e?this.show():this.hide()}}}];return(r=_.map(r,function(e){return _.merge(e,this.settingsConfig)},this)).concat(e||[])},_updateReleaseValues:function(){_.each(this.filterControls,function(e){_.each(e.inlineFilterButton.inlineFilterPanel.advancedFilterPanel.advancedFilterRows.rows,function(e){"Release"===e.name&&e._valueFieldIsValid()&&_.each(e.items.items,function(e){"rallyreleasecombobox"===e.xtype&&this._getRelease(e.originalValue).then(function(t){t&&(e.rawValue=t.Name)})},this)},this)},this)},_addAncestorControls:function(){var e={type:"hbox",align:"middle",defaultMargins:"0 10 0 0"},t=this.ownerLabelWidth;this.cmp.getWidth()<this.singleRowMinWidth&&(e="vbox",t=this.ancestorLabelWidth);var i={xtype:"container",id:"controlsArea",overflowX:"auto",layout:{type:"hbox",align:"top"},items:[{xtype:"container",id:"pubSubIndicatorArea",width:25,padding:"6 5 0 0",hidden:!this.publisher&&!this._isSubscriber(),items:[{xtype:"component",id:"publisherIndicator",html:'<span class="icon-bullhorn icon-large"></span>',hidden:!this.publisher},{xtype:"component",id:"subscriberIndicator",html:'<span class="icon-link icon-large"></span>',hidden:!this._isSubscriber()}]},{xtype:"container",id:"filtersArea",layout:e,items:[{xtype:"container",id:"ancestorFilterArea",layout:{type:"hbox",align:"middle"},items:[{xtype:"container",id:"piTypeArea",layout:{type:"hbox",align:"middle"}},{xtype:"container",id:"piSelectorArea",itemId:"piSelectorArea",layout:{type:"hbox",align:"middle",padding:"0 0 0 5"}}]}]}]};let s={...this.cmp.defaultSettings,...this.cmp.getSettings()};return this.renderArea&&(this.renderArea.setOverflowXY("auto","auto"),this.renderArea.add(i),this._isSubscriber()||!0===s["Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter"]||"true"===s["Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter"]||this.renderArea.down("#filtersArea").add({xtype:"container",itemId:"scopeControlArea",id:"scopeControlArea",width:this._showIgnoreProjectScopeControl()?250:0,margin:this._showIgnoreProjectScopeControl()?"0 10 0 0":0,layout:{type:"hbox",align:"middle"},items:[{xtype:"multifilterscopecontrol",stateId:this.cmp.getContext().getScopedStateId("Utils.AncestorPiAppFilter.ignoreProjectScopeControl"),labelStyle:this.labelStyle,labelWidth:this._showIgnoreProjectScopeControl()?t:0,fieldLabel:this.ownerOnlyLabel,storeConfig:{fields:["text","value"],data:[{text:"Current Project(s)",value:"current"},{text:"Any Project",value:"workspace"}]},listeners:{scope:this,change:function(){this._onSelect()}}}]}),this.filterHelpBtn=Ext.widget("rallybutton",{itemId:"filterHelpBtn",floating:!0,shadow:!1,cls:"filter-help",iconOnly:!0,iconCls:"icon-help",hidden:this._isSubscriber()||!this._showMultiLevelFilter(),handler:(...e)=>this.onHelpClicked(...e)}),this.filterHelpBtn.showBy(this.renderArea,"tr-tr",[-4,5])),this._addTooltips(),new Promise(function(e){!this._isSubscriber()&&this._showAncestorFilter()?this._addPiTypeSelector().then(function(){this._addPiSelector(this.piTypeSelector.getValue(),null).then(function(){e()}.bind(this))}.bind(this)):e()}.bind(this))},_addPiTypeSelector:function(e){return new Promise(function(t){this.piTypeSelector=Ext.create("Rally.ui.combobox.PortfolioItemTypeComboBox",{xtype:"rallyportfolioitemtypecombobox",id:"Utils.AncestorPiAppFilter.piType",name:"Utils.AncestorPiAppFilter.piType",width:250,plugins:[],stateful:!0,stateId:this.cmp.getContext().getScopedStateId("Utils.AncestorPiAppFilter.piType"),stateEvents:["select"],fieldLabel:this.ancestorLabel,labelWidth:this.ancestorLabelWidth,labelStyle:this.labelStyle,valueField:"TypePath",value:e||this._defaultPortfolioItemType(),allowNoEntry:!1,defaultSelectionPosition:"first",listeners:{scope:this,ready:function(e){e.addListener({scope:this,change:this._onPiTypeChange}),t()}}}),this.renderArea.down("#piTypeArea").add(this.piTypeSelector)}.bind(this))},_addTooltips:function(){Ext.tip.QuickTipManager.register({target:"publisherIndicator",text:'This app broadcasts filter settings to any enabled ancestor filtered apps (indicated with <span class="icon-link icon-large"></span>)',showDelay:50,border:!0}),Ext.tip.QuickTipManager.register({target:"subscriberIndicator",text:'This app listens for filter settings from any enabled ancestor filter broadcast app (indicated with <span class="icon-bullhorn icon-large"></span>)',showDelay:50,border:!0}),this._isSubscriber()&&Ext.tip.QuickTipManager.register({target:"subscriberFilterIndicator",text:'This app listens for filter settings from any enabled ancestor filter broadcast app (indicated with <span class="icon-bullhorn icon-large"></span>)',showDelay:50,border:!0})},_onCmpResize:function(e,t){var i={type:"hbox",align:"middle",defaultMargins:"0 10 0 0"};t<this.singleRowMinWidth&&(i={type:"vbox"});var s=this.renderArea.down("#filtersArea");if(s){var r=this.renderArea.down("#controlsArea"),l={xtype:"container",id:"filtersArea",layout:i,items:s.removeAll(!1),hidden:s.isHidden()};r.remove(s,!1),r.add(l)}},_hideControlCmp:function(){this.renderArea&&(this.renderArea.down("#pubSubIndicatorArea").show(),this.renderArea.down("#subscriberIndicator").show(),this.renderArea.down("#filtersArea").hide())},_onPiTypeChange:function(e,t){if(t){let e=this._getValue().pi;this._removePiSelector(),this._addPiSelector(t).then(function(){e&&this._onSelect()}.bind(this))}},_removePiSelector:function(){this.piSelector=null,this.renderArea.down("#piSelectorArea").removeAll(!0)},_addPiSelector:function(e,t){return new Promise(function(i){this.piSelector=Ext.create("Rally.ui.combobox.ArtifactSearchComboBox",{id:"Utils.AncestorPiAppFilter.piSelector",width:250,margin:"0 10 0 10",labelAlign:"top",storeConfig:{models:e,autoLoad:!0,fetch:this.defaultFetch,context:{project:null}},queryDelay:2e3,typeAhead:!1,validateOnChange:!1,stateful:!0,stateId:this.cmp.getContext().getScopedStateId("Utils.AncestorPiAppFilter.piSelector"),stateEvents:["select"],valueField:"_ref",allowClear:!0,clearValue:null,allowNoEntry:this.allowNoEntry,noEntryValue:"",value:t||null,defaultSelectionPosition:null,listeners:{scope:this,select:function(){this._onSelect()},ready:function(){i()}}}),Ext.override(this.piSelector,{saveState:function(){var e,t=this,i=t.stateful&&t.getStateId(),s=t.hasListeners;i&&(e=t.getState()||{},s.beforestatesave&&!1===t.fireEvent("beforestatesave",t,e)||(Ext.state.Manager.set(i,e),s.statesave&&t.fireEvent("statesave",t,e)))}}),this.renderArea.down("#piSelectorArea").add(this.piSelector)}.bind(this))},_setPiSelector:function(e,t){return new Promise(function(i){this.piTypeSelector?(this.piTypeSelector.suspendEvents(!1),this.piTypeSelector.setValue(e),this._removePiSelector(),this._addPiSelector(e,t).then(function(){this.piSelector.setValue(t),this.piTypeSelector.resumeEvents(),i()}.bind(this))):i()}.bind(this))},_showAncestorFilter:function(){let e=this.cmp.getSetting("Utils.AncestorPiAppFilter.enableAncestorPiFilter2");return void 0!==e&&e},_showIgnoreProjectScopeControl:function(){return"user"===(this.cmp.getSetting("Utils.AncestorPiAppFilter.projectScope")||this.projectScope)},_ignoreProjectScope:function(){if(this._isSubscriber())return this.publishedValue.ignoreProjectScope;let e;return"specific"===(e=this._showIgnoreProjectScopeControl()?this.cmp.down("#ignoreScopeControl")&&this.cmp.down("#ignoreScopeControl").getValue():this.cmp.getSetting("Utils.AncestorPiAppFilter.projectScope")||this.projectScope)||"workspace"===e&&!this.disableGlobalScope},_isSubscriber:function(){return this.isSubscriber},_defaultPortfolioItemType:function(){return this.cmp.getSetting("Utils.AncestorPiAppFilter.defaultPiType")},_getPropertyPrefix:function(e,t){let i,s=e.toLowerCase();return"hierarchicalrequirement"===s||"userstory"===s?i=this.getLowestPortfolioItemType().get("Name"):"defect"===s?(i="Requirement",(t=t.slice(1)).length&&(i+=`.${this.getLowestPortfolioItemType().get("Name")}`)):"testcase"===s?(i="WorkProduct",(t=t.slice(1)).length&&(i+=`.${this.getLowestPortfolioItemType().get("Name")}`)):Ext.String.startsWith(s,"portfolioitem")&&(i="Parent"),i&&_.forEach(t.slice(1),function(){i+=".Parent"},this),i},_getAncestorTypeArray:function(e,t){var i,s,r=e.toLowerCase(),l=t.toLowerCase();return"testcase"===r?(i=_.findIndex(this.allTypes,function(e){return e.get("TypePath").toLowerCase()===l}),this.allTypes.slice(0,i+1)):(s=_.findIndex(this.allTypes,function(e){return e.get("TypePath").toLowerCase()===r}))<(i=_.findIndex(this.allTypes,function(e){return e.get("TypePath").toLowerCase()===l}))?this.allTypes.slice(s+1,i+1):null},_showMultiLevelFilter:function(){let e=this.cmp.getSetting("Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter");return void 0===e?this.displayMultiLevelFilter:e},_addFilters:function(){return new Promise(function(e,t){var i=[];this._showMultiLevelFilter()&&!this._isSubscriber()?this.btnRenderArea?this._isSubscriber()?(this.btnRenderArea.add({xtype:"container",id:"filterSubIndicatorArea",width:25,padding:"6 5 0 0",items:[{xtype:"component",id:"subscriberFilterIndicator",html:'<span class="icon-link icon-large"></span>'}]}),e()):(this.showFiltersBtn=this.btnRenderArea.add({xtype:"multifiltertogglebtn",cls:` rly-small ${this.filtersHidden?"secondary":"primary"}`,handler:this._toggleFilters,scope:this,stateId:this.cmp.getContext().getScopedStateId("multi-filter-toggle-button"),listeners:{scope:this,added:function(e){this.filtersHidden&&e.setFiltersHidden(!0),e.filtersHidden?e.setToolTipText("Show Filters"):e.setToolTipText("Hide Filters")}}}),Rally.data.ModelFactory.getModels({types:this._getAllTypePaths().reverse(),context:this.cmp.getContext(),scope:this,success:function(t){this.models=t,this.tabPanel=this.panelRenderArea.add({xtype:"tabpanel",itemId:"multiLevelFilterTabPanel",width:"98%",cls:"blue-tabs",minTabWidth:75,plain:!0,autoRender:!0,hidden:this._isSubscriber()||this.showFiltersBtn.filtersHidden,hideMode:"offsets",items:[]}),this.filterControls=[];let s={},r={},l=1,o={blackListFields:this.blackListFields,whiteListFields:this.whiteListFields},n=this.cmp.getContext();this.cmp.getWidth()<this.singleRowMinWidth&&(s={text:"Clear"},r={fieldLabel:"Match",width:65},o.width=100,l=2);let a={},c=Object.keys(t).length;if(this.visibleTab)for(let e=0;e<c;e++)a[e]=c-e-1;_.each(t,function(e,t){if(this._addStoryAndDefectFiltersToModels(e,t),this.visibleTab&&this.visibleTab.toLowerCase()===t.toLowerCase()){let t=e.ordinal;if("number"==typeof t){let e=a[t+1];"number"==typeof e&&(this.defaultTab=e)}}i.push(new Promise(function(i){let a=`inlineFilter${t}`;this.filterControls.push(Ext.create("Rally.ui.inlinefilter.InlineFilterControl",{xtype:"rallyinlinefiltercontrol",name:a,autoRender:!0,itemId:a,context:n,inlineFilterButtonConfig:{stateful:!0,stateId:this.cmp.getContext().getScopedStateId(`multi-${a}-button`),stateEvents:["inlinefilterchange"],context:this.cmp.getContext(),modelNames:t,filterChildren:this.filterChildren,inlineFilterPanelConfig:{autoRender:!0,name:`${a}-panel`,itemId:`${a}-panel`,model:e,padding:5,width:"98%",context:n,quickFilterPanelConfig:{defaultFields:this.defaultFilterFields,addQuickFilterConfig:{whiteListFields:this.whiteListFields,blackListFields:this.blackListFields}},advancedFilterPanelConfig:{collapsed:this.advancedFilterCollapsed,advancedFilterRowsConfig:{propertyFieldConfig:o,flex:l},matchTypeConfig:r,clearAdvancedButtonConfig:s}},listeners:{inlinefilterchange:this._onFilterChange,inlinefilterready:function(e){this._onFilterReady(e),i()},scope:this}}}))}.bind(this)))},this),Promise.all(i).then(async function(){this._isSubscriber()||(await this.addProjectPicker(),this.clearAllButton=Ext.widget({xtype:"rallybutton",itemId:"clearAllButton",cls:"secondary rly-small clear-all-filters-button",text:"Clear All",margin:"3 9 3 0",hidden:!this._hasFilters(),listeners:{click:()=>this._clearAllFilters(!1),scope:this}}),this.btnRenderArea.add(this.clearAllButton),this.tabPanel.setActiveTab(this.defaultTab),this.filtersHidden&&this.tabPanel.hide(),this.btnRenderArea.setOverflowXY("auto","auto")),e()}.bind(this))},failure:function(){t("Failed to fetch models for multi-level filter")}})):t("Unable to find button render area for multi-level filter"):e()}.bind(this))},_addStoryAndDefectFiltersToModels:function(e,t){t===this.getLowestPortfolioItemType().get("TypePath")?(Rally.data.wsapi.ModelBuilder._addArtifactFieldToModel(e,"Blocked","HasStories"),e.getField("HasStories").displayName="Has Stories"):"HierarchicalRequirement"===t&&(Rally.data.wsapi.ModelBuilder._addArtifactFieldToModel(e,"Blocked","HasDefects"),e.getField("HasDefects").displayName="Has Defects")},_clearAllFilters:function(e){this.suspendEvents(!1);let t=this.tabPanel.getActiveTab();_.each(this.filterControls,function(e){try{this.tabPanel.setActiveTab(e.tab),e.inlineFilterButton.suspendEvents(!1),e.inlineFilterButton.clearAllFilters(),e.inlineFilterButton.saveState(),e.inlineFilterButton.resumeEvents(),this.projectPicker&&this.projectPicker.reset()}catch(e){console.log(e)}}.bind(this)),this.tabPanel.setActiveTab(t),this.resumeEvents(),e||this._onFilterChange()},_hasFilters:function(){var e=this.getMultiLevelFilters(),t=!1;return _.each(e,function(e){e.length&&(t=!0)}),this.projectPicker&&!1===t&&this.projectPicker.getValue().length>0&&(t=!0),t},_onFilterReady:function(e){e.expand();let t=e.quickFilterPanel.getFilters().length+e.advancedFilterPanel.getFilters().length,i=this._getModelName(e),s=this.tabPanel.add({title:i+(t?` (${t})`:""),html:"",itemId:`${i.replace(/\s+/g,"")}-tab`});s.add({xtype:"container",layout:"hbox",items:[e]}),e.tab=s},_getModelName(e){let t=e&&e.model&&e.model.elementName||"unknown";return"HierarchicalRequirement"===t&&(t=e.model.displayName),t},_applyFilters:function(){this.suspendEvents(!1),this.suspendLayouts(),_.each(this.filterControls,function(e){e.inlineFilterButton._applyFilters()}),this.resumeEvents(),this.resumeLayouts(!1),this.updateLayout()},_onFilterChange:function(){this.clearAllButton&&(this._hasFilters()?this.clearAllButton.show():this.clearAllButton.hide()),_.each(this.filterControls,function(e){if(e.inlineFilterButton.inlineFilterPanel){let t=this._getModelName(e.inlineFilterButton.inlineFilterPanel);this._setTabText(t,e.inlineFilterButton.getFilters().length)}},this),this.ready&&this.fireEvent("change",this.getMultiLevelFilters())},_setTabText:function(e,t){var i=t?`${e} (${t})`:e,s=this.tabPanel.child(`#${e.replace(/\s+/g,"")}-tab`);s&&s.setTitle(i)},_toggleFilters:function(e){this.tabPanel.isHidden()?(this.tabPanel.show(),e.setToolTipText("Hide Filters"),e.addCls("primary"),e.removeCls("secondary"),e.setFiltersHidden(!1)):(this.tabPanel.hide(),e.setToolTipText("Show Filters"),e.addCls("secondary"),e.removeCls("primary"),e.setFiltersHidden(!0))},_getAllTypePaths:function(){return _.map(this.allTypes,e=>e.get("TypePath"))},_showError(e,t){Rally.ui.notify.Notifier.showError({message:this.parseError(e,t)})},parseError(e,t){if(t=t||"An unknown error has occurred","string"==typeof e&&e.length)return e;if(e.message&&e.message.length)return e.message;if(e.exception&&e.error&&e.error.errors&&e.error.errors.length){if(e.error.errors[0].length)return e.error.errors[0];if(e.error&&e.error.response&&e.error.response.status)return`${t} (Status ${e.error.response.status})`}return e.exceptions&&e.exceptions.length&&e.exceptions[0].error?e.exceptions[0].error.statusText:e.exception&&e.error&&"string"==typeof e.error.statusText&&!e.error.statusText.length&&e.error.status&&524===e.error.status?"The server request has timed out":t},onHelpClicked(){CustomAgile.ui.tutorial.MultiLevelFilterTutorial.showWelcomeDialog(this)},addProjectPicker(){return new Promise(e=>{let t=this.tabPanel.insert(0,{title:"Projects",itemId:"projectsTab",id:"projectsTab",padding:10}),i={...this.cmp.defaultSettings,...this.cmp.getSettings()};var s=[];"user"===i["Utils.AncestorPiAppFilter.projectScope"]&&("true"===i["Utils.MultiLevelPiAppFilter.projectScope.dropdownCurrent"]&&s.push({text:"Current Project(s)",value:"current"}),"true"===i["Utils.MultiLevelPiAppFilter.projectScope.dropdownAny"]&&s.push({text:"Any Project",value:"workspace"}),"true"===i["Utils.MultiLevelPiAppFilter.projectScope.dropdownSpecific"]&&s.push({text:"Specific Project(s)",value:"specific"})),t.add({xtype:"container",itemId:"scopeControlArea",id:"scopeControlArea",width:this._showIgnoreProjectScopeControl()?250:0,margin:this._showIgnoreProjectScopeControl()?"0 10 0 0":0,layout:{type:"hbox",align:"middle"},items:[{xtype:"multifilterscopecontrol",stateId:this.cmp.getContext().getScopedStateId("Utils.AncestorPiAppFilter.ignoreProjectScopeControl"),labelStyle:this.labelStyle,labelWidth:this._showIgnoreProjectScopeControl()?this.ownerLabelWidth:0,fieldLabel:this.ownerOnlyLabel,storeConfig:{fields:["text","value"],data:s},listeners:{scope:this,change:function(){this._onScopeChange()}}}]}),this.projectPicker=t.add({xtype:"customagileprojectpicker",cmp:this.cmp,appName:"UtilsAncestorPiAppFilter",tab:t,listeners:{scope:this,ready:()=>e(),projectschanged:()=>{this.refreshProjects=!0},applyprojects:async()=>{this.projectsChanged=!0,"specific"===this.tabPanel.down("#ignoreScopeControl").getValue()?this._onChange():(this.projects=[],this.projectPicker.reset(),this.fireEvent("select",this))}}}),this.tabPanel.down("#ignoreScopeControl")&&("specific"!==this.tabPanel.down("#ignoreScopeControl").getValue()?this.hideShowProjectPicker("hide"):this.hideShowProjectPicker("show")),"user"!==i["Utils.AncestorPiAppFilter.projectScope"]&&t.tab.hide()})},getProjectScope(){return this._isSubscriber()?this.publishedValue.scope||"current":this._showIgnoreProjectScopeControl()?this.cmp.down("#ignoreScopeControl")&&this.cmp.down("#ignoreScopeControl").getValue()||"current":this.cmp.getSetting("Utils.AncestorPiAppFilter.projectScope")||this.projectScope},getProjects:async function(){return this._isSubscriber()?this.projects=this.publishedValue.projects||[]:this.projectsChanged&&await this.loadProjects(),this.projects},getProjectIDs:async function(){return await this.getProjects(),this.projects&&this.projects.length>0?_.map(this.projects,e=>e.get("_ref").replace("/project/","")):[]},getProjectRefs:async function(){return await this.getProjects(),this.projects&&this.projects.length>0?_.map(this.projects,e=>e.get("_ref")):[]},_updatePickerFromOldPicker:function(e,t){this.projectPicker&&this.projectPicker.updatePickerFromOldPicker(e,t)},hideShowProjectPicker(e){this.projectPicker&&"hide"===e?(this.projectPicker.projectPicker.hide(),this.projectPicker.down("#pheader").hide(),this.projectPicker.down("#includeChildProjectsCheckbox").hide()):(this.projectPicker.projectPicker.show(),this.projectPicker.down("#pheader").show(),this.projectPicker.down("#includeChildProjectsCheckbox").show(),this.useSpecificProjects()&&this.projectPicker.showApplyProjectsBtn())},_onScopeChange(){this.ready&&(this._showIgnoreProjectScopeControl()&&this.cmp.down("#ignoreScopeControl")&&"specific"===this.cmp.down("#ignoreScopeControl").getValue()?this.hideShowProjectPicker("show"):(this.hideShowProjectPicker("hide"),this.projectPicker&&this.projectPicker.showApplyProjectsBtn()))},async loadProjects(){this.projects=[],this._isSubscriber()?this.projects=this.publishedValue.projects||[]:this.useSpecificProjects()?await this._getSpecificProjectList():"workspace"!==this.getProjectScope()&&await this._getScopedProjectList(),this.projectsChanged=!1},useSpecificProjects(){return this._isSubscriber()?"specific"===this.publishedValue.scope&&this.publishedValue.projects&&this.publishedValue.projects.length:this._showIgnoreProjectScopeControl()&&this.cmp.down("#ignoreScopeControl")&&"specific"===this.cmp.down("#ignoreScopeControl").getValue()&&this.projectPicker&&!!this.projectPicker.getValue().length},async _getSpecificProjectList(){if(this.projectPicker){let e=this.projectPicker.getValue()||[];this.projectPicker.includeChildProjects()&&(e=await this._getAllChildProjects(e)),this.projects=e}else this.projects=[]},async _getAllParentProjects(e){let t=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","ObjectID","Parent"],filters:[{property:"ObjectID",value:e.get("Parent").ObjectID}],limit:1,pageSize:1,autoLoad:!1}),i=await t.load();if(i&&i.length){if(i[0].get("Parent")){let t=await this._getAllParentProjects(i[0]);return[e].concat(t)}return[e,i[0]]}return[e]},async _getAllChildProjects(e=[],t=["Name","Children","ObjectID"]){if(!e.length)return[];const i=e.map(e=>this.wrap(e.getCollection("Children",{fetch:t,limit:1/0,filters:[{property:"State",value:"Open"}]}).load())),s=_.flatten(await Promise.all(i)),r=await this._getAllChildProjects(s,t),l={};let o=_.flatten([...r,...e,...s]);return o.forEach(e=>l[e.get("_ref")]=e),o=Object.values(l)},async _getScopedProjectList(){let e=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","ObjectID","Children","Parent"],filters:[{property:"ObjectID",value:this.cmp.getContext().getProject().ObjectID}],limit:1,pageSize:1,autoLoad:!1}),t=await e.load(),i=[],s=[];t&&t.length?(this.cmp.getContext().getProjectScopeDown()&&(s=await this._getAllChildProjects(t)),this.cmp.getContext().getProjectScopeUp()&&(i=await this._getAllParentProjects(t[0])),s.length?t=s.concat(i.slice(1)):i.length&&(t=i),this.projects=t):this.projects=[]},async wrap(e){return e&&_.isFunction(e.then)?new Promise((t,i)=>{e.then({success(...e){t(...e)},failure(e){Rally.getApp().setLoading(!1),i(e)},scope:this})}):Promise.reject(new Error("Wrap cannot process this type of data into a ECMA promise"))}}),Ext.define("CustomAgile.ui.combobox.MultiFilterScopeControl",{extend:"Rally.ui.combobox.ComboBox",alias:"widget.multifilterscopecontrol",config:{itemId:"ignoreScopeControl",stateful:!0,stateEvents:["select"],displayField:"text",valueField:"value"},setValue:function(e){"boolean"==typeof e&&(e=e?"workspace":"current"),this.callParent(arguments)},applyState:function(e){this.store.loading?this.store.on("load",function(){this.setValue(e.value),this.saveState()},this,{single:!0}):this.setValue(e.value)}}),Ext.define("CustomAgile.ui.picker.MultiSelectTimebox",{extend:"Rally.ui.picker.MultiObjectPicker",alias:"widget.customagilemultiselecttimebox",config:{remoteFilter:!0,maxLength:100,projects:null,pickerCfg:{cls:"multiselect-timebox-picker",minWidth:350},width:150,enableGrouping:!1,toggleOnClick:!0,timeboxStartDateField:"",timeboxEndDateField:""},initComponent(){Rally.ui.list.PagingToolbar.prototype.emptyMsg="No timeboxes",this.callParent(arguments),this.store||this.createStore()},triggerBlur(){const{picker:e}=this;e&&e.isVisible()&&(this.collapse(),this.callParent(arguments))},getMatchedTextHtml:e=>`<div class="timebox-name">${e.Name}</div>`,resetFilters(){},setValueBasedOnState(e=[]){const t=Ext.isString(e)?e.split(","):Ext.Array.from(e);!_.isEmpty(t)&&this.store&&this.store.isLoading()?this.store.on("load",()=>{this._selectValues(t)},this,{single:!0}):this._selectValues(t),this.isExpanded&&(this._onListRefresh(),this._groupSelectedRecords()),this.fireEvent("stateapplied",this,this.selectedValues.getRange(),null)},setDefaultValue(e){this._selectValues(e),this.fireEvent("defaultapplied",this,this.selectedValues.getRange(),null)},getTimeboxOidsInScope(e,t,i){if(e.length>0){let s={model:Ext.identityFn(this.modelType),filters:this._getTimeboxFilters(e),fetch:["Name",this.timeboxStartDateField,this.timeboxEndDateField,"ObjectID"],autoLoad:!0,listeners:{load:(e,s)=>{Ext.callback(t,i,[s])}}};this.projects&&(s.filters=s.filters.and({property:"Project.ObjectID",operator:"in",value:this.projects}),s.context={project:null}),Ext.create("Rally.data.wsapi.Store",s)}else Ext.callback(t,i,[[]])},_getTimeboxFilters(e){let t=[],i={};return _.each(e,e=>{let s=`${e.get("Name")}-${e.get(this.timeboxStartDateField)}-${e.get(this.timeboxEndDateField)}`;if(!i[s]){i[s]=!0;let r=Rally.data.wsapi.Filter.and([{property:"Name",value:e.get("Name")},{property:this.timeboxStartDateField,value:e.get(this.timeboxStartDateField)},{property:this.timeboxEndDateField,value:e.get(this.timeboxEndDateField)}]);t.push(r)}}),Rally.data.wsapi.Filter.or(t)},createStore(){if(!this.store){let e=Ext.create("Rally.data.DataStoreBuilder"),t=Ext.merge({model:this.modelType,requester:this},this.storeConfig);return e.build(t).then({success(e){this.store=e,this.relayEvents(this.store,["datachanged"])},scope:this})}return Promise.resolve(this.store)},_initInputEvents(){this.rendered?(this.on("expand",this.refreshView,this),this.mon(this.inputEl,"keydown",this._onInputKeyDown,this,{buffer:700}),this.mon(this.inputEl,"keyup",this.validate,this,{buffer:700}),this.mon(this.inputEl,"keyup",this._onInputKeyUp,this,{buffer:700})):this.on("afterrender",this._initInputEvents,this,{single:!0})},_onInputTextChanged(){this.store.clearFilter(),this.store.filter({anyMatch:!0,exactMatch:!1,property:"Name",value:this.getInputTextValue()}),this.store.load()},_onInputKeyUp(e){this._setAppropriateEmptyText(),!e.shiftKey&&Rally.util.Event.isModifierKey(e)||this._onInputTextChanged(),""===this.getInputTextValue()&&(this.store.filters&&this.store.filters.clear(),this.store.load())},_createList(){this.listCfg.pageSize=10;let e=Ext.apply({store:this.store,tpl:this._getListTpl(),createPagingToolbar:Ext.bind(this._createPagingToolbar,this)},this.listCfg);return this.list=Ext.create(this.listType,e),this.mon(this.list,{refresh:this._onListRefresh,select:this.onListItemSelect,deselect:this.onListItemDeselect,scope:this}),this.getList().down("rallylistpagingtoolbar").onLoad(),this.list},onListItemSelect(e,t){this.select(t),this._selectRowCheckbox(t.get(this.recordKey)),this._groupRecordsAndScroll(this._getRecordValue()),this.refreshView(),this.fireEvent("select",this,t,this.getValue()),this._fireSelectionChange()},onListItemDeselect(e,t){let i=null;const s=this._getKey(t);this.selectedValues.each(e=>{e.get("_ref")===s&&(i=e)}),i&&this.selectedValues.remove(i),this._syncSelection(),this._deselectRowCheckbox(t.get(this.recordKey)),this._groupRecordsAndScroll(this._getRecordValue()),this.fireEvent("deselect",this,t,this.getValue()),this._fireSelectionChange()},_deselectRowCheckbox(e){this._getOptionCheckbox(e)&&this._getOptionCheckbox(e).removeCls("rui-picker-cb-checked")},_onStoreLoaded(){this._syncSelection(),this.callParent(arguments)},_createPagingToolbar(){return Ext.widget("rallylistpagingtoolbar",{store:this.store,border:!1,layout:{align:"middle"}})}}),Ext.define("CustomAgile.ui.picker.MultiSelectProject",{extend:"CustomAgile.ui.picker.MultiSelectTimebox",alias:"widget.customagilemultiselectproject",requires:["CustomAgile.ui.picker.MultiSelectTimebox"],config:{modelType:"Project",emptyText:"Search projects...",storeConfig:{autoLoad:!0,limit:10,pageSize:10,remoteSort:!0,remoteFilter:!0,fetch:["ObjectID","Name"],sorters:[{property:"Name",direction:"ASC"}],context:{project:null}}},initComponent(){this.callParent(arguments),Rally.ui.list.PagingToolbar.prototype.emptyMsg=`No ${this.modelType}s`},getFilter(){let e=this.getValue();return{property:"Project",operator:"in",value:_.map(e,e=>e.get("_ref"))}},getLookbackFilter(){let e=this.getValue();return{property:"Project",operator:"in",value:_.map(e,e=>e.get("ObjectID"))}}}),Ext.define("Customagile.ui.PillPicker",{extend:"Ext.Container",alias:"widget.customagilepillpicker",pickerCfg:null,showPills:!0,statefulKey:null,sharedSchedules:!1,defaultToRecentTimeboxes:!0,initComponent(){let e=[];if(this.recordsToAdd=[],this.picker=Ext.ComponentManager.create(this.pickerCfg),this.mon(this.picker,"selectionchange",this._onSelectionChange,this),this.mon(this.picker,"select",this._onItemSelect,this),this.mon(this.picker,"deselect",this._onItemDeselect,this),this.mon(this.picker,"expand",this._onInitialExpand,this,{single:!0}),this.items=this._createItems(),this.statefulKey&&(e=JSON.parse(localStorage.getItem(this.statefulKey))),e&&e.length>0)Ext.create("Rally.data.wsapi.RefsToRecords").convert(e,{requester:this}).then({success:e=>{this.sharedSchedules?this.picker.getTimeboxOidsInScope(e,e=>{this.recordsToAdd=e,e&&e.length>0?(this.picker.setValueBasedOnState(e),this._addPills(e),this.saveStateLocal(e)):this._setDefaults()},this):(this.recordsToAdd=e,this.picker.setValueBasedOnState(e),this._addPills(e),this.saveStateLocal(e))},scope:this});else if(this.sharedSchedules){const e=this.picker.store.getRange(0,9);this.defaultToRecentTimeboxes?(this.recordsToAdd=e,this.picker.setDefaultValue(e)):(this.recordsToAdd=[],this.picker.setValueBasedOnState([]))}else this.picker.createStore().then(()=>{this.mon(this.picker,"datachanged",this._onInitialDataChanged,this,{single:!0}),this.picker.setDefaultValue([])},e=>{console.log(e),this.picker.setDefaultValue([])});this.callParent(arguments),this.sharedSchedules&&this._addPills(this.recordsToAdd)},getValue(){const{picker:e}=this;return e?e.getValue():[]},getFilter(){return this.picker&&this.picker.getFilter()},getLookbackFilter(){return this.picker&&this.picker.getLookbackFilter()},saveStateLocal(e){if(this.statefulKey)try{localStorage.setItem(this.statefulKey,JSON.stringify(_.invoke(e,"get","_ref")))}catch(e){}},_onInitialDataChanged(){this._setDefaults()},_setDefaults(){0===this.recordsToAdd.length&&(this.defaultToRecentTimeboxes?Ext.create("Rally.data.wsapi.Store",{model:"Release",autoLoad:!0,limit:4,pageSize:4,remoteSort:!0,remoteFilter:!0,fetch:["ObjectID","Name","ReleaseStartDate","ReleaseDate"],sorters:[{property:"ReleaseDate",direction:"DESC"}],filters:[{property:"ReleaseStartDate",operator:"<",value:new Date}],context:{project:Rally.getApp().getContext().getProjectRef(),projectScopeUp:!1,projectScopeDown:!1},listeners:{scope:this,load:function(e,t,i){i?(this.picker.setDefaultValue(t),this._addPills(t)):this.picker.setDefaultValue([])}}}):this.picker.setValueBasedOnState([]))},_onInitialExpand(){this.picker.getList()&&(this.picker.getList().pagingToolbar.onLoad(),this.picker.getList().refresh())},_addPills(e){let t=e;if(!this.showPills)return;if(this.sharedSchedules){let i={};t=_.filter(e,e=>{let t=`${e.get("Name")}-${e.get(this.startDateFieldName)}-${e.get(this.endDateFieldName)}`;return!i[t]&&(i[t]=!0,!0)})}const i=_.map(t,e=>({xtype:"component",flex:1,itemId:`pill-id-${e.getId()}`,renderTpl:'<span class="tagPill">{Name}<span class="icon-cancel"></span></span>',renderData:e.getData(),renderSelectors:{tagPill:".tagPill",removePillEl:".icon-cancel"},listeners:{click:{element:"tagPill",fn:t=>{t.preventDefault(),this._onRemovePillClick(e)},scope:this}}}),this),s=_.filter(i,e=>_.isEmpty(this.down(`#${e.itemId}`)),this);s.length>0&&this.down("#pillContainer").add(s)},_createItems(){return[this.picker,{itemId:"pillContainer",xtype:"container",cls:"pill-select-container",margin:"10 0 0 0",layout:{type:"table",columns:3}}]},_removePills(){_.each(this.down("#pillContainer").items.getRange(),e=>{e.destroy()})},_removePill(e){let t=this.down(`#pill-id-${e.getId()}`);t&&t.destroy()},_onSelectionChange(e,t){Ext.suspendLayouts(),this._removePills(),this._addPills(t),Ext.resumeLayouts(!0),this.saveStateLocal(t)},_onItemSelect(e,t){this._addPills(Ext.Array.from(t))},_onItemDeselect(e,t){this._removePill(t)},_findSharedSchedules(e){const t=this.picker.selectedValues.getRange(),i=`${e.get("Name")}-${e.get(this.startDateFieldName)}-${e.get(this.endDateFieldName)}`;return _.filter(t,e=>{return`${e.get("Name")}-${e.get(this.startDateFieldName)}-${e.get(this.endDateFieldName)}`===i})},_onRemovePillClick(e){if(this.sharedSchedules){const t=this._findSharedSchedules(e);_.each(t,e=>{this.picker.onListItemDeselect(null,e),this._removePill(e)})}else this.picker.onListItemDeselect(null,e),this._removePill(e);this.saveStateLocal(this.picker.selectedValues.getRange()),this.fireEvent("recordremoved",this.picker.selectedValues,e,this.picker)},_setPillsFromPrjRef(e){return new Promise(t=>{Ext.create("Rally.data.wsapi.RefsToRecords").convert(e,{requester:this}).then({success:e=>{this.recordsToAdd=e,e&&e.length>0?(this.picker.setValueBasedOnState(e),this._addPills(e),this.saveStateLocal(e)):this._setDefaults(),t()},failure:e=>{console.log(e),t()},scope:this})})}}),Ext.define("Customagile.ui.ProjectPicker",{extend:"Ext.Container",alias:"widget.customagileprojectpicker",layout:"vbox",cmp:null,appName:"",tab:null,initComponent(){this.callParent(arguments),this.add([{xtype:"component",html:"If you require a report spanning across multiple project hierarchies, use this project picker to specify where the data will be pulled from. If blank, app will respect user's current project scoping.",itemId:"pheader",cls:"x-form-item-label"},{xtype:"customagilepillpicker",itemId:"projectPicker",hidden:!1,statefulKey:this.cmp.getContext().getScopedStateId(this.appName+"-project-picker"),defaultToRecentTimeboxes:!1,listeners:{recordremoved:this.showApplyProjectsBtn,scope:this},pickerCfg:{xtype:"customagilemultiselectproject",width:350,margin:"10 0 0 0",listeners:{stateapplied:()=>this._onReady(),defaultapplied:()=>this._onReady(),blur:this.showApplyProjectsBtn,scope:this}}},{xtype:"rallycheckboxfield",itemId:"includeChildProjectsCheckbox",fieldLabel:"Show work from child projects",labelSeparator:"",stateful:!0,stateId:this.cmp.getContext().getScopedStateId(this.appName+"-scope-down-checkbox"),stateEvents:["change"],labelWidth:200,listeners:{scope:this,change:this.showApplyProjectsBtn}},{xtype:"rallybutton",itemId:"applyProjectsBtn",text:"Apply",margin:"10 0 0 0",hidden:!0,handler:function(e){e.hide(),this.fireEvent("applyprojects")}.bind(this)}]),this.projectPicker=this.down("#projectPicker")},_onReady(){setTimeout(()=>this.updateProjectTabText(),1e3),this.fireEvent("ready")},showApplyProjectsBtn(){this.down("#applyProjectsBtn")&&this.down("#applyProjectsBtn").show(),this.updateProjectTabText(),this.fireEvent("projectschanged")},updateProjectTabText(){if(this.tab)if(this.cmp.down("#ignoreScopeControl")&&"workspace"===this.cmp.down("#ignoreScopeControl").getValue())this.tab.setTitle("PROJECTS (ALL)");else if(this.projectPicker&&!this.projectPicker.hidden){let e=this.projectPicker.getValue().length,t=e?`PROJECTS (${e})`:"PROJECTS";this.tab.setTitle(t)}else this.tab.setTitle("PROJECTS")},getValue(){return this.projectPicker.getValue()},includeChildProjects(){return this.down("#includeChildProjectsCheckbox").getValue()},setIncludeChildProjects(e){this.down("#includeChildProjectsCheckbox").setValue(e)},reset(){this.projectPicker._removePills(),this.projectPicker.picker.setValueBasedOnState([]),this.projectPicker.saveStateLocal([]),this.updateProjectTabText(),this.down("#includeChildProjectsCheckbox").setValue(!1),this.projectPicker.picker.setDefaultValue([]),this.down("#applyProjectsBtn")&&this.down("#applyProjectsBtn").hide()},getProjectRefs(){return _.map(this.projectPicker.getValue(),e=>e.get("_ref"))},async setValueFromPrjRef(e,t){this.setIncludeChildProjects(t),await this.projectPicker._setPillsFromPrjRef(e)},async updatePickerFromOldPicker(e,t){let i=JSON.parse(localStorage.getItem(this.cmp.getContext().getScopedStateId(e+"-project-picker")));i&&i.length>0&&(await this.setValueFromPrjRef(i,t),localStorage.removeItem(this.cmp.getContext().getScopedStateId(e+"-project-picker")))}});
                Ext.define("CycleTimeCalculator",{config:{bucketBy:""},constructor:function(t){this.initConfig(t)},prepareChartData:function(t){var e=this._groupData(t.getRange()),r=_.keys(e),n=_.transform(e,function(t,e,r){t[r]=this._computeCycleTimes(e)},{},this);return{categories:r,series:[{name:"Cycle Time (Median)",type:"column",data:_.map(n,function(t,e){return[e,this._computePercentile(.5,t)]},this)},{name:"P25 - P75",type:"errorbar",data:_.map(n,function(t){return this._computePercentiles(t)},this),showInLegend:!0}]}},_computeCycleTimes:function(t){return _.sortBy(_.map(t,function(t){var e=t.get("ActualStartDate"),r=t.get("ActualEndDate");return moment(r).diff(moment(e),"days")}))},_computePercentiles:function(t){var e=this._computePercentile(.25,t),r=this._computePercentile(.75,t);return e===r?[]:[e,r]},_computePercentile:function(t,e){var r=t*e.length,n=Math.floor(r);return 1===e.length?e[0]:n===r?(e[n]+e[n-1])/2:e[n]},_groupData:function(t){return _.groupBy(t,function(t){var e=t.get("ActualEndDate");return"month"===this.bucketBy?moment(e).startOf("month").format("MMM 'YY"):"quarter"===this.bucketBy?moment(e).startOf("quarter").format("YYYY [Q]Q"):"release"===this.bucketBy?t.get("Release")._refObjectName:"year"===this.bucketBy?moment(e).startOf("year").format("YYYY"):void 0},this)}});
                Ext.define("PICycleTimeChartApp",{extend:"Rally.app.App",componentCls:"app",autoScroll:!1,requires:["CycleTimeCalculator"],layout:{type:"vbox",align:"stretch"},items:[{id:Utils.AncestorPiAppFilter.RENDER_AREA_ID,xtype:"container",layout:{type:"hbox",align:"middle",defaultMargins:"0 10 10 0"}},{id:Utils.AncestorPiAppFilter.PANEL_RENDER_AREA_ID,xtype:"container",layout:{type:"hbox",align:"middle",defaultMargins:"0 10 10 0"}},{id:"chart-area",xtype:"container",flex:1,type:"vbox",align:"stretch"}],config:{defaultSettings:{bucketBy:"quarter",piType:"",query:""}},launch:function(){this.setLoading(!0),Rally.data.wsapi.Proxy.superclass.timeout=24e4,this.down("#chart-area").on("resize",this.onResize,this),this.getSetting("piType")?this._loadPIModel(this.getSetting("piType")):Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",sorters:[{property:"Ordinal"}],fetch:["DisplayName","TypePath"],filters:[{property:"Parent.Name",value:"Portfolio Item"},{property:"Creatable",value:!0}]}).load().then({success:function(e){this._loadPIModel(e[0].get("TypePath"))},scope:this})},_loadPIModel:function(e){Rally.data.wsapi.ModelFactory.getModel({type:e}).then({success:function(e){this.model=e,this._addFilters()},failure:function(){this.showError(`Unable to load model type "${e}". Please verify the settings are configured correctly.`)},scope:this})},_addFilters:function(){this.ancestorFilterPlugin=Ext.create("Utils.AncestorPiAppFilter",{ptype:"UtilsAncestorPiAppFilter",pluginId:"ancestorFilterPlugin",visibleTab:this.model.typePath,displayMultiLevelFilter:!0,listeners:{scope:this,ready:function(e){e.addListener({scope:this,select:this._addChart,change:this._addChart}),this._addChart()}}}),this.addPlugin(this.ancestorFilterPlugin)},_addChart:async function(){let e=this.down("#chart-area");e.removeAll();let t=this.getContext(),r=[this.model.typePath],a=await this._getFilters(),i={xtype:"rallygridboard",toggleState:"chart",chartConfig:this._getChartConfig(),context:t,modelNames:r,storeConfig:{filters:a},listeners:{scope:this,afterrender:function(){this.setLoading(!1),this.addExportButton(),this.onResize()}}};e.add(i)},_getChartConfig:function(){let e=this.getContext().getDataContext();return this.ancestorFilterPlugin.getIgnoreProjectScope()&&(e.project=null),{xtype:"rallychart",chartColors:["#937bb7"],height:this.down("#chart-area").getHeight()-20,storeType:"Rally.data.wsapi.Store",storeConfig:{context:e,limit:3e4,fetch:this._getChartFetch(),sorters:this._getChartSort(),pageSize:2e3,model:this.model},calculatorType:"CycleTimeCalculator",calculatorConfig:{bucketBy:this.getSetting("bucketBy")},chartConfig:{chart:{type:"column",animation:!1},legend:{enabled:!0},title:{text:""},yAxis:{min:0,title:{text:"Days"}},plotOptions:{column:{dataLabels:{enabled:!1}}}}}},_getChartFetch:function(){return["ActualStartDate","ActualEndDate","Release"]},_getChartSort:function(){return this._isByRelease()?[{property:"Release.ReleaseDate",direction:"ASC"}]:[{property:"ActualEndDate",direction:"ASC"}]},_getFilters:async function(){let e=[{property:"ActualEndDate",operator:"!=",value:null}];this._isByRelease()&&e.push({property:"Release",operator:"!=",value:null});let t=this.getContext().getTimeboxScope();t&&t.isApplicable(this.model)&&!this._isByRelease()&&e.push(t.getQueryFilter()),this.getSetting("query")&&e.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query")));let r=await this.ancestorFilterPlugin.getAllFiltersForType(this.model.typePath,!0).catch(e=>{this.showError(e)});return r&&(e=e.concat(r)),e},_isByRelease:function(){return"release"===this.getSetting("bucketBy")},onTimeboxScopeChange:function(){this.callParent(arguments);let e=this.down("rallygridboard");e&&e.destroy(),this._addChart()},onResize:function(){this.callParent(arguments);var e=this.down("#chart-area"),t=this.down("rallygridboard");e&&t&&t.setHeight(e.getHeight()-20)},getSettingsFields:function(){return[{name:"piType",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],allowBlank:!1,editable:!1,autoSelect:!1,validateOnChange:!1,validateOnBlur:!1,fieldLabel:"Type",shouldRespondToScopeChange:!0,storeConfig:{model:"TypeDefinition",sorters:[{property:"Ordinal"}],fetch:["DisplayName","TypePath"],filters:[{property:"Parent.Name",value:"Portfolio Item"},{property:"Creatable",value:!0}],autoLoad:!1,remoteFilter:!0,remoteSort:!0},displayField:"DisplayName",valueField:"TypePath",listeners:{change:function(e){e.fireEvent("typeselected",e.getValue(),e.context)},ready:function(e){e.fireEvent("typeselected",e.getValue(),e.context)}},bubbleEvents:["typeselected"],readyEvent:"ready",handlesEvents:{projectscopechanged:function(e){this.refreshWithNewContext(e)}}},{name:"bucketBy",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Bucket By",displayField:"name",valueField:"value",editable:!1,allowBlank:!1,store:{fields:["name","value"],data:[{name:"Month",value:"month"},{name:"Quarter",value:"quarter"},{name:"Release",value:"release"},{name:"Year",value:"year"}]},lastQuery:"",handlesEvents:{typeselected:function(e){Rally.data.ModelFactory.getModel({type:e,success:function(e){this.store.filterBy(function(t){return"release"!==t.get("value")||0===e.typeDefinition.Ordinal}),this.store.findRecord("value",this.getValue())||this.setValue("month")},scope:this})}}},{type:"query"}]},addExportButton:function(){this.down("#"+Utils.AncestorPiAppFilter.RENDER_AREA_ID).add({xtype:"rallybutton",iconCls:"icon-export",cls:"rly-small secondary export-btn",handler:this._export,margin:"0 20 7 0",scope:this,toolTipText:"Export..."})},_export:function(){let e=this.down("rallychart");if(!e)return void this.showError("No chart data to export.");let t=e&&e.getChartData();if(!t)return void this.showError("No chart data to export.");let r=[],a=[],i=this.getSetting("bucketBy"),o=_.pluck(t.series,"name"),s=[i].concat(o);r.push(s.join(","));for(let e=0;e<t.categories.length;e++)(a=[t.categories[e]]).push(t.series[0].data[e][1]),t.series[1].data[e].length?a.push(`${t.series[1].data[e][0]} - ${t.series[1].data[e][1]}`):a.push("N/A"),r.push(a.join(","));r=r.join("\r\n");let l=`cycle-time-${Rally.util.DateTime.format(new Date,"Y-m-d-h-i-s")}.csv`;CATS.workitemThroughput.utils.Toolbox.saveAs(r,l)},showError(e,t){this.setLoading(!1),Rally.ui.notify.Notifier.showError({message:this.parseError(e,t)})},parseError(e,t){if(t=t||"An unknown error has occurred","string"==typeof e&&e.length)return e;if(e.message&&e.message.length)return e.message;if(e.exception&&e.error&&e.error.errors&&e.error.errors.length){if(e.error.errors[0].length)return e.error.errors[0];if(e.error&&e.error.response&&e.error.response.status)return`${t} (Status ${e.error.response.status})`}return e.exceptions&&e.exceptions.length&&e.exceptions[0].error?e.exceptions[0].error.statusText:e.exception&&e.error&&"string"==typeof e.error.statusText&&!e.error.statusText.length&&e.error.status&&524===e.error.status?"The server request has timed out":t},async wrapPromise(e){return e&&_.isFunction(e.then)?new Promise((t,r)=>{e.then({success(...e){t(...e)},failure(e){Rally.getApp().setLoading(!1),r(e)},scope:this})}):Promise.reject(new Error("Wrap cannot process this type of data into a ECMA promise"))},setLoading(e){this.down("#chart-area").setLoading(e)}});
                Ext.define("CATS.workitemThroughput.utils.Toolbox",{singleton:!0,saveCSVToFile:function(e,o,i){void 0===i&&(i={type:"text/csv;charset=utf-8"}),this.saveAs(e,o,i)},saveAs:function(e,o){if(Ext.isIE9m)Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for IE9 and below."});else{var i=null;try{i=new Blob([e],{type:"text/plain"})}catch(o){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,window.BlobBuilder&&"TypeError"==o.name&&(bb=new BlobBuilder,bb.append([e]),i=bb.getBlob("text/plain"))}if(i){var t=o;if(Ext.isIE10p)window.navigator.msSaveOrOpenBlob(i,t);else{var n=this.createObjectURL(i);if(n){var l=document.createElement("a");"download"in l?l.download=t:l.target="_blank",l.innerHTML="Download File",l.href=n,Ext.isChrome||(l.onclick=this.destroyClickedElement,l.style.display="none",document.body.appendChild(l)),l.click()}else Rally.ui.notify.Notifier.showError({message:"Export is not supported "})}}else Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for this browser."})}},createObjectURL:function(e){return window.webkitURL?window.webkitURL.createObjectURL(e):window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(e):null},destroyClickedElement:function(e){document.body.removeChild(e.target)}});

            Rally.launchApp('PICycleTimeChartApp', {
                name:"PI Cycle Time Chart",
                parentRepos:"",
                version:"1.1.0"
            });

        });
    </script>


    <style type="text/css">
        .blue-tabs .x-tab-bar .x-tab-default{background-color:white;border-radius:4px 4px 0 0}.blue-tabs .x-tab-bar .x-tab-default .x-tab-inner{color:#00a9e0}.blue-tabs .x-tab-bar .x-tab-active{background-color:#00a9e0}.blue-tabs .x-tab-bar .x-tab-active .x-tab-inner{color:white}.blue-tabs .x-tab-bar .x-tab-default .x-tab-inner{text-overflow:initial;-o-text-overflow:initial;overflow:initial}.blue-tabs .x-tab-bar .x-tab-inner{width:100%}.blue-tabs .x-tab-bar .x-tab-default .x-tab-icon-el{color:white}.filter-help{border-color:#d6d6d6 !important}.icon-help{font-size:16px;text-align:center;color:#327c98 !important}.icon-help:hover{color:#21516d !important}.filter-help .x-btn-button{height:18px !important;width:18px !important}.filter-help-list li{padding-bottom:6px}
    </style>
    <style type="text/css">
        .export-btn{right:70px !important;left:auto !important}
    </style>
</head>
<body>
</body>
</html>
