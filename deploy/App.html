<!DOCTYPE html>
<html>
<head>
    <title>PI Cycle Time Chart</title>
    <!--  (c) 2020 Custom Agile.  All Rights Reserved. -->
    <!--  Build Date: Wed Feb 05 2020 19:47:19 GMT+0100 (Central European Standard Time) -->
    <!--  Version: "1.0.10"-->
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CycleTimeCalculator",{config:{bucketBy:""},constructor:function(t){this.initConfig(t)},prepareChartData:function(t){var e=this._groupData(t.getRange()),r=_.keys(e),n=_.transform(e,function(t,e,r){t[r]=this._computeCycleTimes(e)},{},this);return{categories:r,series:[{name:"Cycle Time (Median)",type:"column",data:_.map(n,function(t,e){return[e,this._computePercentile(.5,t)]},this)},{name:"P25 - P75",type:"errorbar",data:_.map(n,function(t){return this._computePercentiles(t)},this),showInLegend:!0}]}},_computeCycleTimes:function(t){return _.sortBy(_.map(t,function(t){var e=t.get("ActualStartDate"),r=t.get("ActualEndDate");return moment(r).diff(moment(e),"days")}))},_computePercentiles:function(t){var e=this._computePercentile(.25,t),r=this._computePercentile(.75,t);return e===r?[]:[e,r]},_computePercentile:function(t,e){var r=t*e.length,n=Math.floor(r);return 1===e.length?e[0]:n===r?(e[n]+e[n-1])/2:e[n]},_groupData:function(t){return _.groupBy(t,function(t){var e=t.get("ActualEndDate");return"month"===this.bucketBy?moment(e).startOf("month").format("MMM 'YY"):"quarter"===this.bucketBy?moment(e).startOf("quarter").format("YYYY [Q]Q"):"release"===this.bucketBy?t.get("Release")._refObjectName:"year"===this.bucketBy?moment(e).startOf("year").format("YYYY"):void 0},this)}});
                Ext.define("PICycleTimeChartApp",{extend:"Rally.app.App",componentCls:"app",layout:"fit",autoScroll:!1,requires:["CycleTimeCalculator"],config:{defaultSettings:{bucketBy:"quarter",piType:"",query:""}},launch:function(){this.getSetting("piType")?this._loadPIModel(this.getSetting("piType")):Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",sorters:[{property:"Ordinal"}],fetch:["DisplayName","TypePath"],filters:[{property:"Parent.Name",value:"Portfolio Item"},{property:"Creatable",value:!0}]}).load().then({success:function(e){this._loadPIModel(e[0].get("TypePath"))},scope:this})},_loadPIModel:function(e){Rally.data.wsapi.ModelFactory.getModel({type:e}).then({success:function(e){this.model=e,this._addChart()},failure:function(){Rally.ui.notify.Notifier.showError({message:'Unable to load model type "'+e+'". Please verify the settings are configured correctly.'})},scope:this})},getSettingsFields:function(){return[{name:"piType",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],allowBlank:!1,editable:!1,autoSelect:!1,validateOnChange:!1,validateOnBlur:!1,fieldLabel:"Type",shouldRespondToScopeChange:!0,storeConfig:{model:"TypeDefinition",sorters:[{property:"Ordinal"}],fetch:["DisplayName","TypePath"],filters:[{property:"Parent.Name",value:"Portfolio Item"},{property:"Creatable",value:!0}],autoLoad:!1,remoteFilter:!0,remoteSort:!0},displayField:"DisplayName",valueField:"TypePath",listeners:{change:function(e){e.fireEvent("typeselected",e.getValue(),e.context)},ready:function(e){e.fireEvent("typeselected",e.getValue(),e.context)}},bubbleEvents:["typeselected"],readyEvent:"ready",handlesEvents:{projectscopechanged:function(e){this.refreshWithNewContext(e)}}},{name:"bucketBy",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Bucket By",displayField:"name",valueField:"value",editable:!1,allowBlank:!1,store:{fields:["name","value"],data:[{name:"Month",value:"month"},{name:"Quarter",value:"quarter"},{name:"Release",value:"release"},{name:"Year",value:"year"}]},lastQuery:"",handlesEvents:{typeselected:function(e){Rally.data.ModelFactory.getModel({type:e,success:function(e){this.store.filterBy(function(t){return"release"!==t.get("value")||0===e.typeDefinition.Ordinal}),this.store.findRecord("value",this.getValue())||this.setValue("month")},scope:this})}}},{type:"query"}]},_addChart:function(){var e=this.getContext(),t=["Milestones","Tags","c_EnterpriseApprovalEA"],a=[this.model.typePath],i={xtype:"rallygridboard",toggleState:"chart",chartConfig:this._getChartConfig(),plugins:[{ptype:"rallygridboardinlinefiltercontrol",showInChartMode:!0,inlineFilterButtonConfig:{stateful:!0,stateId:e.getScopedStateId("filters"),filterChildren:!1,modelNames:a,inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:[],addQuickFilterConfig:{whiteListFields:t}},advancedFilterPanelConfig:{advancedFilterRowsConfig:{propertyFieldConfig:{whiteListFields:t}}}}}}],context:e,modelNames:a,storeConfig:{filters:this._getFilters()},listeners:{scope:this,afterrender:function(){this.addExportButton()}}};this.add(i)},_getChartConfig:function(){return{xtype:"rallychart",chartColors:["#937bb7"],storeType:"Rally.data.wsapi.Store",storeConfig:{context:this.getContext().getDataContext(),limit:1/0,fetch:this._getChartFetch(),sorters:this._getChartSort(),pageSize:2e3,model:this.model},calculatorType:"CycleTimeCalculator",calculatorConfig:{bucketBy:this.getSetting("bucketBy")},chartConfig:{chart:{type:"column"},legend:{enabled:!0},title:{text:""},yAxis:{min:0,title:{text:"Days"}},plotOptions:{column:{dataLabels:{enabled:!1}}}}}},onTimeboxScopeChange:function(){this.callParent(arguments);var e=this.down("rallygridboard");e&&e.destroy(),this._addChart()},_getChartFetch:function(){return["ActualStartDate","ActualEndDate","Release"]},_getChartSort:function(){return this._isByRelease()?[{property:"Release.ReleaseDate",direction:"ASC"}]:[{property:"ActualEndDate",direction:"ASC"}]},_isByRelease:function(){return"release"===this.getSetting("bucketBy")},_getFilters:function(){var e=[{property:"ActualEndDate",operator:"!=",value:null}];this._isByRelease()&&e.push({property:"Release",operator:"!=",value:null});var t=this.getContext().getTimeboxScope();return t&&t.isApplicable(this.model)&&!this._isByRelease()&&e.push(t.getQueryFilter()),this.getSetting("query")&&e.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),e},addExportButton:function(){let e=this.down("rallyleftright");e&&e.getRight()&&e.getRight().add({xtype:"rallybutton",iconCls:"icon-export",cls:"rly-small secondary",handler:this._export,margin:"0 20 7 0",scope:this,toolTipText:"Export..."})},_export:function(){var e=this.down("rallychart");if(e){var t=e&&e.getChartData();if(t){var a=[],i=this.getSetting("bucketBy"),l=_.pluck(t.series,"name"),r=[i].concat(l);a.push(r.join(","));for(var o=0;o<t.categories.length;o++)row=[t.categories[o]],row.push(t.series[0].data[o][1]),t.series[1].data[o].length?row.push(`${t.series[1].data[o][0]} - ${t.series[1].data[o][1]}`):row.push("N/A"),a.push(row.join(","));a=a.join("\r\n");var n=`cycle-time-${Rally.util.DateTime.format(new Date,"Y-m-d-h-i-s")}.csv`;CATS.workitemThroughput.utils.Toolbox.saveAs(a,n)}else Rally.ui.notify.Notifier.showError({message:"No chart data to export."})}else Rally.ui.notify.Notifier.showError({message:"No chart data to export."})}});
                Ext.define("CATS.workitemThroughput.utils.Toolbox",{singleton:!0,saveCSVToFile:function(e,o,i){void 0===i&&(i={type:"text/csv;charset=utf-8"}),this.saveAs(e,o,i)},saveAs:function(e,o){if(Ext.isIE9m)Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for IE9 and below."});else{var i=null;try{i=new Blob([e],{type:"text/plain"})}catch(o){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,window.BlobBuilder&&"TypeError"==o.name&&(bb=new BlobBuilder,bb.append([e]),i=bb.getBlob("text/plain"))}if(i){var t=o;if(Ext.isIE10p)window.navigator.msSaveOrOpenBlob(i,t);else{var n=this.createObjectURL(i);if(n){var l=document.createElement("a");"download"in l?l.download=t:l.target="_blank",l.innerHTML="Download File",l.href=n,Ext.isChrome||(l.onclick=this.destroyClickedElement,l.style.display="none",document.body.appendChild(l)),l.click()}else Rally.ui.notify.Notifier.showError({message:"Export is not supported "})}}else Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for this browser."})}},createObjectURL:function(e){return window.webkitURL?window.webkitURL.createObjectURL(e):window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(e):null},destroyClickedElement:function(e){document.body.removeChild(e.target)}});

            Rally.launchApp('PICycleTimeChartApp', {
                name:"PI Cycle Time Chart",
                parentRepos:"",
                version:"1.0.10"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
